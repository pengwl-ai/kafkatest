# Kafka 性能测试工具设计文档

## 1. 项目概述

本项目旨在创建一个使用 Go 语言开发的 Kafka 性能测试工具，用于验证当前节点到 Kafka 的消费和生产性能指标。

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Kafka 性能测试工具                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   生产者测试    │  │   消费者测试    │  │   配置管理   │ │
│  │   Producer      │  │   Consumer      │  │   Config     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   性能指标收集  │  │   报告生成      │  │   日志系统   │ │
│  │   Metrics       │  │   Report        │  │   Logger     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心模块

1. **生产者测试模块 (Producer)**
    - 负责向 Kafka 发送消息
    - 支持可配置的消息大小、发送速率、并发数等参数
    - 收集发送延迟、吞吐量等性能指标

2. **消费者测试模块 (Consumer)**
    - 负责从 Kafka 消费消息
    - 支持可配置的消费速率、并发数等参数
    - 收集消费延迟、处理速度等性能指标

3. **配置管理模块 (Config)**
    - 管理测试工具的配置参数
    - 支持命令行参数和配置文件
    - 包括 Kafka 连接配置、测试参数等

4. **性能指标收集模块 (Metrics)**
    - 收集和计算性能指标
    - 支持实时监控和历史数据记录
    - 计算平均值、百分位数等统计信息

5. **报告生成模块 (Report)**
    - 生成性能测试报告
    - 支持多种输出格式（控制台、JSON、CSV等）
    - 提供可视化图表支持

6. **日志系统 (Logger)**
    - 提供统一的日志记录功能
    - 支持不同级别的日志输出
    - 可配置的日志格式和输出位置

## 3. 技术选型

### 3.1 核心依赖

- **Go**: 主要开发语言
- **segmentio/kafka-go**: Kafka 客户端库
- **spf13/cobra**: 命令行参数解析
- **spf13/viper**: 配置管理
- **sirupsen/logrus**: 日志系统
- **stretchr/testify**: 单元测试框架

### 3.2 项目结构

```
kafkatest/
├── cmd/                    # 命令行入口
│   ├── root.go            # 根命令
│   ├── producer.go        # 生产者测试命令
│   └── consumer.go        # 消费者测试命令
├── internal/              # 内部实现
│   ├── config/            # 配置管理
│   │   └── config.go
│   ├── producer/          # 生产者实现
│   │   └── producer.go
│   ├── consumer/          # 消费者实现
│   │   └── consumer.go
│   ├── metrics/           # 性能指标收集
│   │   └── metrics.go
│   ├── report/            # 报告生成
│   │   └── report.go
│   └── logger/            # 日志系统
│       └── logger.go
├── pkg/                   # 可导出的包
│   └── utils/             # 工具函数
│       └── utils.go
├── configs/               # 配置文件
│   └── config.yaml
├── test/                  # 测试文件
│   └── integration_test.go
├── go.mod                 # Go 模块文件
├── go.sum                 # 依赖校验
└── README.md              # 项目说明
```

## 4. 功能设计

### 4.1 生产者测试功能

- 支持指定主题（Topic）
- 可配置消息大小、数量、发送速率
- 支持并发发送
- 记录发送延迟、吞吐量等指标
- 支持多种消息内容生成策略（随机、固定、模板等）

### 4.2 消费者测试功能

- 支持指定主题（Topic）和消费者组
- 可配置消费速率、并发数
- 记录消费延迟、处理速度等指标
- 支持消息确认机制

### 4.3 性能指标

- **生产者指标**:
    - 消息发送总数
    - 消息发送速率（消息/秒）
    - 吞吐量（字节/秒）
    - 平均延迟、最小延迟、最大延迟
    - 延迟百分位数（P50, P90, P95, P99）

- **消费者指标**:
    - 消息消费总数
    - 消息消费速率（消息/秒）
    - 吞吐量（字节/秒）
    - 处理延迟
    - 消费滞后（Consumer Lag）

### 4.4 配置管理

- 支持命令行参数和配置文件
- 可配置 Kafka 服务器地址
- 可配置测试参数（消息大小、数量、速率等）
- 可配置输出格式和位置

## 5. 使用场景

### 5.1 生产者性能测试

```bash
# 基本生产者测试
./kafkatest producer --topic test-topic --message-size 1024 --message-count 10000

# 高级生产者测试
./kafkatest producer \
  --topic test-topic \
  --message-size 1024 \
  --message-count 100000 \
  --rate 1000 \
  --concurrency 10 \
  --brokers kafka1:9092,kafka2:9092 \
  --output json
```

### 5.2 消费者性能测试

```bash
# 基本消费者测试
./kafkatest consumer --topic test-topic --group test-group

# 高级消费者测试
./kafkatest consumer \
  --topic test-topic \
  --group test-group \
  --concurrency 5 \
  --brokers kafka1:9092,kafka2:9092 \
  --duration 60s \
  --output json
```

## 6. 性能优化考虑

- 使用连接池管理 Kafka 连接
- 批量发送和接收消息以提高吞吐量
- 异步处理非关键路径操作
- 内存使用优化，避免频繁的内存分配
- 使用高效的序列化/反序列化方法

## 7. 扩展性考虑

- 支持插件式架构，便于添加新的测试场景
- 支持自定义指标收集器
- 支持多种输出格式和存储后端
- 支持分布式测试场景

## 8. 测试策略

- 单元测试：测试各个模块的核心功能
- 集成测试：测试与 Kafka 的交互
- 性能测试：验证工具本身的性能
- 端到端测试：完整的测试流程验证